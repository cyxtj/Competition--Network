

import pandas
import numpy as np
folder = 'indexes/RU100/'
inputfilename = folder + r'index-each-sector-week.xlsx'
outputfilename = folder + 'index-each-sector-week.h5'
outputcolumnname = folder + 'column_names.txt'
t = pandas.read_excel(inputfilename, 'Sheet1')


# add date information
dates = [ 130109, 130110,  130111,  130112,  130113,  130114,  130115,  130116,  130117,  130118,  130119,  130120,  130121,  130122,  130123,  130124,  130125,  130126,  130127,  130128,  130129,  130130,  130131,  130201,  130202,  130203,  130204,  130205,  130206,  130207,  130208,  130209,  130210,  130211,  130212,  130213,  130214,  130215,  130216,  130217,  130218,  130219,  130220,  130221,  130222,  130223,  130224,  130225,  130226,  130227,  130228,  130301,  130302,  130303,  130304,  130305,  130306,  130307,  130308,  130309,  130310,  130311,  130312,  130313,  130314,  130315,  130316,  130317,  130318,  130319,  130320,  130321,  130322,  130323,  130324,  130325,  130326,  130327,  130328,  130329,  130330,  130331,  130401,  130402,  130403,  130404,  130405,  130406,  130407,  130408,  130409,  130410,  130411,  130412,  130413,  130414,  130415,  130416,  130417,  130418,  130419,  130420,  130421,  130422,  130423,  130424,  130425,  130426,  130427,  130428,  130429,  130430,  130501,  130502,  130503,  130504,  130505,  130506,  130507,  130508,  130509,  130510,  130511,  130512,  130513,  130514,  130515,  130516,  130517,  130518,  130519,  130520,  130521,  130522,  130523,  130524,  130525,  130526,  130527,  130528,  130529,  130530,  130531,  130601,  130602,  130603,  130604,  130605,  130606,  130607,  130608,  130609,  130610,  130611,  130612,  130613,  130614,  130615,  130616,  130617,  130618,  130619,  130620,  130621,  130622,  130623,  130624,  130625,  130626,  130627,  130628,  130629,  130630,  130701,  130702,  130703,  130704,  130705,  130706,  130707,  130708,  130709,  130710,  130711,  130712,  130713,  130714,  130715,  130716,  130717,  130718,  130719,  130720,  130721,  130722,  130723,  130724,  130725,  130726,  130727,  130728,  130729,  130730,  130731,  130801,  130802,  130803,  130804,  130805,  130806,  130807,  130808,  130809,  130810,  130811,  130812,  130813,  130814,  130815,  130816,  130817,  130818,  130819,  130820,  130821,  130822,  130823,  130824,  130825,  130826,  130827,  130828,  130829,  130830,  130831,  130901,  130902,  130903,  130904,  130905,  130906,  130907,  130908,  130909,  130910,  130911,  130912,  130913,  130914,  130915,  130916,  130917,  130918,  130919,  130920,  130921,  130922,  130923,  130924,  130925,  130926,  130927,  130928,  130929,  130930,  131001,  131002,  131003,  131004,  131005,  131006,  131007,  131008,  131009,  131010,  131011,  131012,  131013,  131014,  131015,  131016,  131017,  131018,  131019,  131020,  131021,  131022,  131023,  131024,  131025,  131026,  131027,  131028,  131029,  131030,  131031,  131101,  131102,  131103,  131104,  131105,  131106,  131107,  131108,  131109,  131110,  131111,  131112,  131113,  131114,  131115,  131116,  131117,  131118,  131119,  131120,  131121,  131122,  131123,  131124,  131125,  131126,  131127,  131128,  131129,  131130,  131201,  131202,  131203,  131204,  131205,  131206,  131207,  131208,  131209,  131210,  131211,  131212,  131213,  131214,  131215,  131216,  131217,  131218,  131219,  131220,  131221,  131222,  131223,  131224,  131225,  131226,  131227,  131228,  131229,  131230,  131231,  140101,  140102,  140103,  140104,  140105,  140106,  140107,  140108,  140109,  140110,  140111,  140112,  140113,  140114,  140115,  140116,  140117,  140118,  140119,  140120,  140121,  140122,  140123,  140124,  140125,  140126,  140127,  140128,  140129,  140130,  140131,  140201,  140202,  140203,  140204,  140205,  140206,  140207,  140208,  140209,  140210,  140211,  140212,  140213,  140214,  140215,  140216,  140217,  140218,  140219,  140220,  140221,  140222,  140223,  140224,  140225,  140226,  140227,  140228,  140301,  140302,  140303,  140304,  140305,  140306,  140307,  140308,  140309,  140310,  140311,  140312,  140313,  140314,  140315,  140316,  140317,  140318,  140319,  140320,  140321,  140322,  140323,  140324,  140325,  140326,  140327,  140328,  140329,  140330,  140331,  140401,  140402,  140403,  140404,  140405,  140406,  140407,  140408,  140409,  140410,  140411,  140412,  140413,  140414,  140415,  140416,  140417,  140418,  140419,  140420,  140421,  140422,  140423,  140424,  140425,  140426,  140427,  140428,  140429,  140501,  140502,  140503,  140504,  140505,  140506,  140507,  140508,  140509,  140510,  140511,  140512,  140513,  140514,  140515,  140516,  140517,  140518,  140519,  140520,  140521,  140522,  140523,  140524,  140525,  140526,  140527,  140528,  140529,  140530,  140531,  140601,  140602,  140603,  140604,  140605,  140606,  140607,  140608,  140609,  140610,  140611,  140612,  140613,  140614,  140615,  140616,  140617,  140618,  140619,  140620,  140621,  140622,  140623,  140624,  140625,  140626,  140627,  140628,  140629,  140630,  140701,  140702,  140703,  140704,  140705,  140706,  140707,  140708,  140709,  140710,  140711,  140712,  140713,  140714,  140715,  140716,  140717,  140718,  140719,  140720,  140721,  140722,  140723,  140724,  140725,  140726,  140727,  140728,  140729,  140730,  140731,  140801,  140802,  140803,  140804,  140805,  140806,  140807,  140808,  140809,  140810,  140811,  140812,  140813,  140814,  140815,  140816,  140817,  140818,  140819,  140820,  140821,  140822,  140823,  140824,  140825,  140826,  140827,  140828,  140829,  140830,  140831,  140901,  140902,  140903,  140904,  140905,  140906,  140907,  140908,  140909,  140910,  140911,  140912,  140913,  140914,  140915,  140916,  140917,  140918,  140919,  140920,  140921,  140922,  140923,  140924]
weeks = range(1, 90)
weeks_start_date = [dates[7*(week-1)] for week in weeks]
weeks_end_date = [dates[7*(week)-1] for week in weeks]
s = np.zeros(t.shape[0], dtype=int)
e = np.zeros(t.shape[0], dtype=int)
W = t['WEEK'].values
for i, w in enumerate(W):
    s[i] = weeks_start_date[w-1]
    e[i] = weeks_end_date[w-1]

t['week_start_date'] = s
t['week_end_date'] = e
t['HHI_N'] = (t['HHI'] - 1/t['NUser'] ) / (1 - 1/t['NUser'])
t['CCI'] = t['CCI'] * 100
t['CCI_C'] = t['CCI_C'] * 100
# t['userPer_80perClick'] = t['userNumber_80percentClick'] / t['NUser'] * 100
t['logNUser'] = np.log(t['NUser'])
t['NEqualUser'] = 1/t['HHI']

# add difference information
# g = t.groupby('SECTOR')
# diff_info = {}
# n = 0
# for name, group in g:
#     group = group.sort(columns='WEEK')
#     diff_info[name] = group.diff().iloc[1:, :]
#     diff_info[name]['SECTOR'] = name
#     diff_info[name]['WEEK'] = range(1, 89)
#     n += diff_info[name].shape[0]
# 
# diff_table = np.zeros([n, t.shape[1]])
# i = 0
# for k in diff_info:
#     v = diff_info[k]
#     diff_table[i: i+v.shape[0], :] = v
#     i += v.shape[0]
# 
# diff_table = pandas.DataFrame(diff_table, columns=t.columns)
# t = diff_table
# # t.to_excel(r'index-each-sector-week1.xlsx')

import h5py
f = h5py.File(outputfilename, 'w')
f.create_dataset('indexes', data=t.values)
f.close()

f = open(outputcolumnname, 'w')
f.write(','.join(t.columns.values.tolist()))
f.close()
